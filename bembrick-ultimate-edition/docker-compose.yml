# GENESIS 2.0 — Docker Compose
#
# Usage:
#   docker compose up              Start all services
#   docker compose up --build      Rebuild and start
#   docker compose run genesis verify   Run verification suite
#
# Volumes:
#   genesis-data   Persistent audit logs, evidence chains, signing keys
#
# Copyright (c) 2025 MuzzL3d Dictionary Contributors — Apache-2.0

services:
  genesis:
    build: .
    container_name: genesis-core
    ports:
      - "${GENESIS_PDP_PORT:-8080}:8080"       # Policy Decision Point API
      - "${GENESIS_DASHBOARD_PORT:-3000}:3000"  # Dashboard + health UI
    volumes:
      - genesis-data:/data
    environment:
      - GENESIS_AUDIT_DIR=/data/audit
      - GENESIS_EVIDENCE_DIR=/data/evidence
      - GENESIS_KEY_DIR=/data/keys
      - GENESIS_PDP_PORT=8080
      - GENESIS_DASHBOARD_PORT=3000
      - GENESIS_OWNER_ID=${GENESIS_OWNER_ID:-owner}
      - GENESIS_OVERRIDE_SECRET_HASH=${GENESIS_OVERRIDE_SECRET_HASH:-}
      - NODE_ENV=production
    restart: unless-stopped
    read_only: true
    tmpfs:
      - /tmp:size=64M
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:8080/health').then(r=>{if(!r.ok)process.exit(1)}).catch(()=>process.exit(1))"]
      interval: 30s
      timeout: 5s
      retries: 3

volumes:
  genesis-data:
    driver: local
